name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      
      - name: Install dependencies and build
        run: |
          echo "Installing Node dependencies..."
          npm install
          
          echo "Building assets..."
          npm run build
          
          echo "Installing Composer dependencies (production only)..."
          composer install --no-dev --optimize-autoloader --no-interaction
      
      - name: Create clean plugin directory
        run: |
          echo "Creating plugin directory..."
          mkdir -p blogshq-admin-toolkit
          
          echo "Copying files based on .distignore..."
          
          # Copy all files first
          rsync -av --progress . blogshq-admin-toolkit/ \
            --exclude='.git' \
            --exclude='blogshq-admin-toolkit'
          
          # Remove files listed in .distignore
          while IFS= read -r pattern; do
            # Skip empty lines and comments
            [[ -z "$pattern" || "$pattern" =~ ^#.*$ ]] && continue
            
            # Remove the pattern from plugin directory
            echo "Removing: $pattern"
            rm -rf "blogshq-admin-toolkit/$pattern"
          done < .distignore
          
          echo "Plugin directory created successfully"
      
      - name: Verify plugin structure
        run: |
          echo "Verifying plugin structure..."
          ls -la blogshq-admin-toolkit/
          
          echo "Checking for main plugin file..."
          if [ ! -f "blogshq-admin-toolkit/blogshq-admin-toolkit.php" ]; then
            echo "Error: Main plugin file not found!"
            exit 1
          fi
          
          echo "Checking for lib directory..."
          if [ ! -d "blogshq-admin-toolkit/lib" ]; then
            echo "Error: lib directory not found!"
            exit 1
          fi
          
          echo "Structure verification complete"
      
      - name: Create ZIP file
        run: |
          echo "Creating ZIP file..."
          cd blogshq-admin-toolkit
          zip -r ../blogshq-admin-toolkit-${{ steps.get_version.outputs.VERSION }}.zip . -x "*.git*"
          cd ..
          
          echo "ZIP file created successfully"
          ls -lh blogshq-admin-toolkit-${{ steps.get_version.outputs.VERSION }}.zip
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: blogshq-admin-toolkit-${{ steps.get_version.outputs.VERSION }}.zip
          body: |
            ## BlogsHQ Admin Toolkit v${{ steps.get_version.outputs.VERSION }}
            
            ### ðŸ“¥ Installation
            1. Download `blogshq-admin-toolkit-${{ steps.get_version.outputs.VERSION }}.zip`
            2. Go to WordPress Admin â†’ Plugins â†’ Add New â†’ Upload Plugin
            3. Upload the ZIP file and activate
            4. Plugin will automatically check for updates
            
            ### ðŸ”„ Automatic Updates
            Once installed, the plugin will:
            - Automatically check for updates from this repository
            - Display update notifications in WordPress admin
            - Allow one-click updates directly from WordPress
            
            ### ðŸ“ Changelog
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for detailed changes.
            
            ### ðŸ› Found an Issue?
            Report bugs on our [Issues page](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf blogshq-admin-toolkit
          echo "Cleanup complete"